generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

// DEPRECATED: Solana/Drift
enum AgentWalletStatus {
  ACTIVE
  INACTIVE
  REVOKED
}

model User {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // DEPRECATED: Solana
  walletAddress String?    @unique
  
  // EVM wallet address
  evmAddress    String?    @unique
  
  nonce         String?
  lastLoginAt   DateTime?

  name   String?
  avatar String?
  role   UserRole   @default(USER)
  status UserStatus @default(ACTIVE)

  // DEPRECATED: Drift
  driftAgentWallet DriftAgentWallet? @relation("DriftAgentWallet")
  
  // Hyperliquid agent wallet - ONE per user
  hyperliquidWallet HyperliquidWallet? @relation("HyperliquidWallet")
}

// DEPRECATED: Solana/Drift
model DriftAgentWallet {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, name: "DriftAgentWallet")

  publicKey          String @unique
  encryptedSecretKey String

  isDelegated     Boolean           @default(false)
  delegatedAt     DateTime?
  subaccountIndex Int               @default(0)
  status          AgentWalletStatus @default(ACTIVE)
  isActivated Boolean   @default(false)
  activatedAt DateTime?
  gasBalance String @default("0")
  encryptionVersion String @default("v1")

  @@index([userId])
  @@index([publicKey])
  @@map("AgentWallet")
}

// MINIMAL: Just store the agent key
model HyperliquidWallet {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, name: "HyperliquidWallet")

  // Agent address (used as identifier on Hyperliquid)
  agentAddress        String @unique
  
  // Encrypted private key for signing orders
  encryptedAgentKey   String

  // Which master wallet this agent signs for
  masterAddress       String

  encryptionVersion   String   @default("v1")

  @@index([userId])
  @@index([agentAddress])
}
